{% extends 'lay.html' %}

{% block title %}
   Public profile 
{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #F4F2EC;
            font-size: 12px;
        }
        .thin-line {
    width: 100%; /* Full width */
    height: 1px; /* Thin line */
    background-color: rgba(0, 0, 0, 0.2); /* Light gray color */
    margin: 10px 0; /* Add spacing above and below */
}

        /* Profile Section */
        .profile {
            max-width: 900px;
            background: white;
            padding: 20px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            margin: 80px auto;
            bottom:0px;
            margin-bottom: 100px;
            margin-top: 60px;
            margin-left: -1px;
        }

        /* Header Section */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .initials {
            background: #00613a;
            ;
            color: white;
            font-size: 24px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .info-details {
            text-align: left;
        }

        .info h1 {
            margin: 0;
            font-size: 16px;
        }

        .info p {
            margin: 5px 0 0;
            color: gray;
            font-size: 12px;
            display: flex;
            align-items: center;
        }

        .info p img {
            width: 14px;
            height: 14px;
            margin-left: 5px;
        }

        .actions .btn {
            background: #00613a;
            ;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            margin-left: 5px;
            font-size: 12px;
        }

        /* Bio Section */
        .bio, .services, .reviews-section {
            margin: 20px 0;
        }

        /* Services Section */
        .services h2 {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .services-options {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        .radio-container {
            display: flex;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }

        .radio-container input[type="radio"] {
            margin-right: 10px;
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        /* Reviews Section */
        .reviews-section {
            position: relative;
            margin-top: 20px;
            overflow: hidden;
        }

          .reviews-section h2 {
            margin-bottom: 10px;
            font-size: 14px;
        }
       
        .reviews-container {
    position: relative;
    display: flex;
    align-items: center;
    overflow: hidden;
    width: 100%;
}
.review-card-stars i { 
    color: #ff6600; /* Orange color for stars in review cards */ 
    font-size: 12px; /* Adjust size as needed */ 
    margin-right: 2px; /* Space between stars */ 

}
.reviews-scroll {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-behavior: smooth;
    padding: 1rem;
    scrollbar-width: none; /* Firefox */
}

.reviews-scroll::-webkit-scrollbar {
    display: none; /* Chrome, Safari */
}

.review.card {
    min-width: 250px;
    flex-shrink: 0;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 1rem;
    background: #f9f9f9;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.scroll-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: #fff;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    font-size: 1.5rem;
    z-index: 10;
    opacity: 0.7;
    transition: opacity 0.3s;
}

.scroll-btn:hover {
    opacity: 1;
}

.scroll-btn.left {
    left: 0;
}

.scroll-btn.right {
    right: 0;
}

        .review {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            width: 160px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 160px;
            text-align: center;
            border: 1px solid #ccc;
            margin: 0 10px;
            flex-shrink: 0;
        }

        /* Review Popup */
        .review-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        /* Stars Rating */
        .stars i {
            color: #e6e6e6;
            font-size: 35px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

/* Your existing styles here */
#stars i {
    color: #ff6600; /* Orange color for stars */
    font-size: 12px; /* Adjust size as needed */
    margin-right: 2px; /* Space between stars */
}



        .stars i.active {
            color: #ff6600;
        }

        /* Arrow Buttons */
        .arrow-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: #ff6600;
            color: white;
            font-size: 18px;
            padding: 10px;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .arrow-btn:hover {
            background: #ff4d00;
        }

        .prev-btn {
            left: 10px;
        }

        .next-btn {
            right: 10px;
        }
    </style>

    <!-- Profile Content -->
    <div class="profile">
        <div id="alert-placeholder"></div>
        <!-- Header Section -->
        <div class="header">
            <div class="info">
                <div class="initials">{{ user.Fullname[0] }}</div>
                <div class="info-details">
                    <h1>{{ user.Fullname }}</h1>
                    <p>
                        <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="location">  {{user.region_name}}
                    </p>
                
                    <div id="stars"> 
                        {% for i in range(1, 6) %} 
                        {% if i <= average_rating %} 
                        <i class="fas fa-star"></i> 
                        {% elif i - average_rating < 1 %} 
                        <i class="fas fa-star-half-alt"></i> 
                        {% else %} <i class="far fa-star"></i> 
                        {% endif %} 
                        {% endfor %} 
                    </div>
                </div>
            </div>
            <div class="actions">
                {% if session.get('user_id') %}
                {% if ongoing_request %}
                <!-- If there's an ongoing request -->
                <button id="end-request-button" class="btn btn-danger" data-request-id="{{ ongoing_request.id }}" >
                    End Request
                </button>
                
                
               {% else %}
               <!-- If no ongoing request -->
               <button id="start-request-button" class="btn btn-primary" data-user-id="{{ user_id }}">
                Start Request
            </button>
            <button id="end-request-button" class="btn btn-danger" style="display: none;">
                 End Request 
                </button>
                {% endif %}


                <button class="btn start-chat-btn" data-user2-id="{{ user_id }}">
                    Start Chat
                </button>
                {% endif %}
                
                
            </div>
        </div>
        <div class="thin-line"></div>
        <!-- Bio Section -->
        <div class="bio">
           
            <p>{{ user.bio }}</p>
        </div>
        <div class="thin-line"></div>
        <!-- Services Section -->
        <div class="services">
            <h2>Services:</h2>
            <div class="services-options">
                {% for service in services %}
                <label class="radio-container">
                    <input type="radio" name="services" value="{{ service.id }}" id="service_{{ service.id }}">
                    <label for="service_{{ service.id }}">{{ service.service_name }}</label>
                </label>
                {% endfor %}
            </div>
        </div>
        
        <div class="thin-line"></div>


       <!-- Reviews Section -->
<div class="reviews-section">
    <h2>Reviews:</h2>
    <div class="reviews-container">
        <button class="scroll-btn left" onclick="scrollReviews('left')">❮</button>
        <div class="reviews-scroll">
            {% for review in reviews %}
            <div class="review card">
                <div class="card-body">
                    <p><strong>{{ review.reviewer_name }}</strong></p>
                    <div class="review-card-stars"> 
                        {% for i in range(1, 6) %} 
                        {% if i <= review.rating %} 
                        <i class="fas fa-star"></i> 
                        {% elif i - review.rating < 1 %} 
                        <i class="fas fa-star-half-alt"></i> 
                        {% else %} <i class="far fa-star"></i> 
                        {% endif %} 
                        {% endfor %} 
                    </div>
                    <p>{{ review.review }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        <button class="scroll-btn right" onclick="scrollReviews('right')">❯</button>
    </div>
</div>

    </div>

    <!-- Review Popup -->
    <div class="modal fade" id="review-popup" tabindex="-1" aria-labelledby="review-popup-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="review-popup-label">Rate the service</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="stars">
        <i class="fa fa-star" data-value="1"></i>
        <i class="fa fa-star" data-value="2"></i>
        <i class="fa fa-star" data-value="3"></i>
        <i class="fa fa-star" data-value="4"></i>
        <i class="fa fa-star" data-value="5"></i>
    </div>
    <label for="comment">Comment:</label>
    <textarea id="comment" class="form-control" rows="4"></textarea>
    <label for="hours">Hours:</label>
    <input type="number" id="hours" class="form-control" placeholder="Enter number of hours" required />
    <small class="form-text text-muted">Your time credit will be increased based on the hours spent.</small>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    <button type="button" class="btn btn-primary" id="submit-review-btn" data-request-id="{{ ongoing_request.id }}" disabled >Submit</button>
</div>
</div>
</div>
</div>
 

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const user1_id = '{{ user1_id }}';  // Make user1_id accessible in JavaScript
</script>

<script>
function showBootstrapAlert(message, type = 'info') {
    const alertPlaceholder = document.getElementById('alert-placeholder');
    alertPlaceholder.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
}

document.addEventListener("DOMContentLoaded", function() {
    const user1_id = '{{ user1_id }}'; // Ensure this is fetched correctly in your template

    function startChat(user1_id, user2_id) {
        console.log('Starting chat with user:', user1_id, 'and requester:', user2_id); // Debugging

        fetch('/start_chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user1_id: user1_id, user2_id: user2_id }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Response from server:', data); // Debugging
            if (data.room_id) {
                window.location.href = '/chat/' + data.room_id;
            } else {
                console.error('Failed to create chat room:', data.error);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }

    document.querySelectorAll('input[name="services"]').forEach(input => {
        input.addEventListener("change", enableRequestButton);
    });

    function scrollReviews(direction) {
        const container = document.querySelector('.reviews-scroll');
        const scrollAmount = 300; // Adjust the scroll distance as needed

        if (direction === 'left') {
            container.scrollLeft -= scrollAmount;
        } else if (direction === 'right') {
            container.scrollLeft += scrollAmount;
        }
    }

    function handleEndRequestButton() {
        const endRequestBtn = document.getElementById("end-request-button");
        if (endRequestBtn) {
            endRequestBtn.addEventListener("click", function() {
                const requestId = this.dataset.requestId;
                console.log("End Request Button Clicked, Request ID:", requestId);
                const reviewPopup = new bootstrap.Modal(document.getElementById('review-popup'));
                reviewPopup.show();
                document.getElementById("submit-review-btn").dataset.requestId = requestId; // Set the request ID for submit review
            });
        }
    }

    // Call the function to handle the "End Request" button on page load
    handleEndRequestButton();

    const startRequestBtn = document.getElementById("start-request-button");
    if (startRequestBtn) {
        startRequestBtn.addEventListener("click", function() {
            console.log("Start Request button clicked");

            const selectedService = document.querySelector('input[name="services"]:checked');
            if (selectedService) {
                console.log("Selected Service Element:", selectedService);
                const service_id = selectedService.value;
                console.log("Selected Service ID:", service_id);

                const provider_id = this.getAttribute('data-user-id');
                console.log("Provider ID:", provider_id);

                if (!service_id || !provider_id) {
                    showBootstrapAlert('Please select a service and ensure the provider is valid.', 'warning');
                    return;
                }

                const requester_id = '{{ session["user_id"] }}';
                console.log("Requester ID:", requester_id);

                fetch('/start_request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ service_id: service_id, provider_id: provider_id, requester_id: requester_id }),
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Request response:', data); // Debugging
                    if (data.request_id) {
                        showBootstrapAlert('Request started successfully', 'success');

                        const endRequestBtn = document.createElement("button");
                        endRequestBtn.id = "end-request-button";
                        endRequestBtn.className = "btn btn-danger";
                        endRequestBtn.style.display = "inline-block";
                        endRequestBtn.innerText = "End Request";
                        endRequestBtn.dataset.requestId = data.request_id;

                        const actionsDiv = document.querySelector(".actions");
                        if (actionsDiv) {
                            actionsDiv.replaceChild(endRequestBtn, startRequestBtn);
                            console.log("End Request Button Added");
                            handleEndRequestButton(); // Reattach the event listener to the new button
                        } else {
                            console.error("Actions Div NOT Found!");
                        }
                    } else {
                        showBootstrapAlert('Failed to start request: ' + data.error, 'danger');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    showBootstrapAlert('chack your time credit', 'danger');
                });
            } else {
                console.log("No service selected");
                showBootstrapAlert('Please select a service.', 'warning');
            }
        });
    }

    const startChatButtons = document.querySelectorAll('.start-chat-btn');
    startChatButtons.forEach(button => {
        button.addEventListener('click', () => {
            const user2_id = button.getAttribute('data-user2-id');
            console.log('Chat Button Clicked, User2 provider ID:', user2_id); // Debugging
            const user1_id = '{{ session["user_id"] }}';
                console.log("Requester ID:", user1_id);

            if (!user1_id) {
                console.error("user1_id is not defined.");
                return;
            }
            startChat(user1_id, user2_id);
        });
    });

    function enableRequestButton() {
        const selected = document.querySelector('input[name="services"]:checked');
        const startRequestButton = document.getElementById("start-request-button");
        if (startRequestButton) {
            startRequestButton.disabled = !selected;
        }
    }

    function showServiceSelection() {
        const serviceSelection = document.querySelector('.services-options');
        if (serviceSelection) {
            serviceSelection.scrollIntoView({ behavior: 'smooth' });
        }
    }

    function updateStarRating(tempRating = selectedRating) {
        stars.forEach((star) => {
            const value = parseInt(star.dataset.value, 10);
            star.classList.toggle("active", value <= tempRating);
        });
    }

    const stars = document.querySelectorAll(".stars i");
    let selectedRating = 0;

    stars.forEach((star) => {
        const value = parseInt(star.dataset.value, 10);

        star.addEventListener("click", () => {
            selectedRating = value;
            updateStarRating();
        });

        star.addEventListener("mouseover", () => {
            updateStarRating(value);
        });

        star.addEventListener("mouseout", () => {
            updateStarRating();
        });
    });

    document.getElementById("hours").addEventListener("input", function() {
        document.getElementById("submit-review-btn").disabled = !this.value;
    });

    document.getElementById("submit-review-btn").addEventListener("click", function() {
        const comment = document.getElementById("comment").value;
        const hours = parseInt(document.getElementById("hours").value);
        const requestId = this.dataset.requestId; // Get request_id from data attribute
        console.log("Request ID for review submission: ", requestId); // Debugging
        const rating = selectedRating;

        if (!comment || !hours || !selectedRating) {
            showBootstrapAlert('Please provide a rating, comment, and hours.', 'warning');
            return;
        }

        fetch('/submit_review', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ request_id: requestId, rating: rating, comment: comment, hours: hours }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showBootstrapAlert('Review submitted successfully', 'success');
                // Update the time credit in the navigation bar without reloading the page 
                document.querySelector('.time-credit').textContent = 'Time Credit: ' + data.requester_time_credit;
                location.reload();
            } else {
                showBootstrapAlert('Failed to submit review: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            showBootstrapAlert('Failed to submit review due to a network error or server issue.', 'danger');
        });
    });
});

    
    </script>
    
{% endblock %}
